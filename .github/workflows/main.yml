name: Make MemReduct EXE

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest # 최신 SDK가 포함된 환경 사용
    
    steps:
    - name: Checkout MemReduct
      uses: actions/checkout@v4
      with:
        path: memreduct

    - name: Checkout Routine Library
      uses: actions/checkout@v4
      with:
        repository: henrypp/routine
        path: routine

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    # [핵심 단계] 프로젝트 파일을 강제로 수정하여 호환성 확보
    - name: Patch Project Settings
      shell: pwsh
      run: |
        $proj = "memreduct/memreduct.vcxproj"
        $content = Get-Content $proj
        # 1. 지원 안되는 stdclatest를 stdc17로 변경
        $content = $content -replace 'stdclatest', 'stdc17'
        # 2. 강제로 v143(VS2022) 툴셋 사용하도록 변경
        $content = $content -replace '<PlatformToolset>v145</PlatformToolset>', '<PlatformToolset>v143</PlatformToolset>'
        # 3. 경고를 에러로 처리하는 옵션 제거
        $content = $content -replace '<TreatWarningsAsErrors>true</TreatWarningsAsErrors>', '<TreatWarningsAsErrors>false</TreatWarningsAsErrors>'
        Set-Content $proj $content

    # [빌드 실행] 환경 변수와 SDK 버전을 명시적으로 지정
    - name: Build Solution
      run: |
        cd memreduct
        msbuild memreduct.sln `
          -p:Configuration=Release `
          -p:Platform=x64 `
          -p:PlatformToolset=v143 `
          -p:WindowsTargetPlatformVersion=10.0 `
          -p:CharacterSet=Unicode `
          -p:TreatWarningsAsErrors=false

    - name: Upload EXE
      uses: actions/upload-artifact@v4
      with:
        name: memreduct_result
        path: memreduct/bin/64/memreduct.exe
