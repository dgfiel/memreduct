name: Make MemReduct EXE

on:
  workflow_dispatch:

jobs:
  build:
    # 1. 호환성을 위해 Windows 2019 환경 유지
    runs-on: windows-2019
    
    steps:
    - name: Checkout MemReduct
      uses: actions/checkout@v4
      with:
        path: memreduct

    - name: Checkout Routine Library
      uses: actions/checkout@v4
      with:
        repository: henrypp/routine
        path: routine

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    # 2. [추가된 단계] 프로젝트 파일 내용을 직접 수정합니다.
    # "stdclatest"라는 단어를 찾아서 "stdc17"로 바꿔치기 합니다.
    - name: Patch Project File
      run: |
        powershell -Command "(Get-Content memreduct/memreduct.vcxproj) -replace 'stdclatest', 'stdc17' | Set-Content memreduct/memreduct.vcxproj"

    # 3. 컴파일 실행
    # 이제 파일 내용이 바뀌었으므로 에러가 나지 않을 것입니다.
    - name: Build Solution
      run: |
        cd memreduct
        msbuild memreduct.sln -p:Configuration=Release -p:Platform=x64 -p:PlatformToolset=v142 -p:TreatWarningsAsErrors=false

    - name: Upload EXE
      uses: actions/upload-artifact@v4
      with:
        name: memreduct_result
        path: memreduct/bin/64/memreduct.exe
