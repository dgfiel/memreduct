name: Make MemReduct EXE

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout MemReduct
      uses: actions/checkout@v4
      with:
        path: memreduct

    - name: Checkout Routine Library
      uses: actions/checkout@v4
      with:
        repository: henrypp/routine
        path: routine

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1

    # [핵심] 소스 코드 및 프로젝트 파일 강제 수정
    - name: Patch Source and Project
      shell: pwsh
      run: |
        # 1. 프로젝트 파일 수정 (도구 버전 및 경고 무시 설정)
        $proj = "memreduct/memreduct.vcxproj"
        (Get-Content $proj) `
          -replace '<PlatformToolset>v145</PlatformToolset>', '<PlatformToolset>v143</PlatformToolset>' `
          -replace '<TreatWarningsAsErrors>true</TreatWarningsAsErrors>', '<TreatWarningsAsErrors>false</TreatWarningsAsErrors>' `
          -replace 'stdclatest', 'stdc17' | Set-Content $proj

        # 2. 소스 코드 수정 (인자 개수 불일치 해결)
        # routine 라이브러리 변경으로 인한 함수 호출 인자 제거 패치
        $mainFile = "memreduct/src/main.c"
        $c = Get-Content $mainFile
        $c = $c -replace '(_r_config_get\w+)\(([^,]+,[^,]+),[^)]+\)', '$1($2)'
        $c = $c -replace '(_r_config_set\w+)\(([^,]+,[^,]+),[^)]+\)', '$1($2)'
        
        # 3. 누락된 시스템 헤더 강제 삽입
        $header = "#include <windows.h>`n#include <mountmgr.h>`n"
        $header + $c | Set-Content $mainFile

    # [빌드 실행]
    - name: Build Solution
      run: |
        cd memreduct
        msbuild memreduct.sln `
          -p:Configuration=Release `
          -p:Platform=x64 `
          -p:PlatformToolset=v143 `
          -p:WindowsTargetPlatformVersion=10.0 `
          -p:TreatWarningsAsErrors=false

    - name: Upload EXE
      uses: actions/upload-artifact@v4
      with:
        name: memreduct_result
        path: memreduct/bin/64/memreduct.exe
